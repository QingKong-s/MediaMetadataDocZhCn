# FLAC元数据格式

## 备注

**本节为译者添加。**

**翻译自：**

+ <https://xiph.org/flac/documentation_format_overview.html>
+ <https://xiph.org/flac/format.html>

**译者非音乐或数字多媒体行业专业人士，组织此文档仅用于软件开发，部分机翻错误已纠正，若有专业术语翻译错误或不合理的情况，请提交拉取请求或issue。**

**译者不对本文作任何保证，包括但不限于行文描述准确性的保证，读者应自行评判准确性并对可能因参考本文造成的错误承担一切责任。**

## 概述

本页从软件开发人员的角度介绍了FLAC格式的各个方面，换言之，介绍了FLAC文件中的哪些比特和字节包含哪些信息，以及应如何对这些信息进行编码或解码。有关面向用户的概述，请参阅[关于FLAC格式](https://xiph.org/flac/documentation_format_overview.html)。

## 格式

本节规定了FLAC比特流格式。FLAC没有格式版本信息，但在多处包含保留空间。未来版本的格式可以安全地使用这些保留空间，而不会破坏旧数据流的格式。旧版解码器可选择中止解码或跳过使用新方法编码的数据。除预留模式外，该格式还指定了一些无效模式，这意味着这些模式永远不会出现在任何有效的比特流中，也不会出现在该格式之前、现在或未来的版本中。这些无效模式通常用于使同步机制更加稳健。

FLAC比特流中使用的所有数字都是整数，没有浮点表示法。所有数字都是大端编码。除非另有说明，否则所有数字都是无符号的。

在正式描述比特流之前，我们先来了解一下比特流的概况。
FLAC比特流由位于流开头的"FLAC"标记、一个强制性元数据块(称为`STREAMINFO`块)、任意数量的其他元数据块以及音频帧组成。

FLAC支持多达128种元数据块；目前定义的元数据块如下：

+ `STREAMINFO` 该块包含整个流的信息，如采样率、通道数、采样总数等。它必须作为流中的第一个元数据块出现。其他元数据块可能紧随其后，解码器无法理解的元数据块将被跳过。

+ `APPLICATION` 此块供第三方应用程序使用。唯一的必填字段是一个32位标识符。该标识符由FLAC维护者根据应用程序的要求授予。区块的其余部分由注册应用程序定义。如果您想为您的应用程序在FLAC注册一个ID，请访问[注册页面](https://xiph.org/flac/id.html)。

+ `PADDING` 该块允许任意数量的填充。`PADDING`块的内容没有任何意义。用户可以指示编码器预留足够大小的`PADDING`块，以便在添加元数据时，只需覆盖填充(相对较快)，而不必将其插入现有文件的正确位置(通常需要重写整个文件)。

+ `SEEKTABLE` 这是一个可选块，用于存储查找点。在没有查找表的情况下，可以查找到FLAC流中的任何给定样本，但延迟可能无法预测，因为比特率在流中的变化可能很大。通过在数据流中添加查找点，可以大大减少这种延迟。每个查找点需要18个字节，因此一个数据流中1%的分辨率增加不到2k。一个数据流中只能有一个`SEEKTABLE`，但该表可以有任意数量的查找点。还有一个特殊的"占位符"寻址点，解码器会忽略它，但它可以用来为将来插入寻址点预留空间。

+ `VORBIS_COMMENT` 该块用于存储人类可读的名称/值对列表。值使用UTF-8编码。它是Vorbis注释规范的实现(不含成帧位)。这是FLAC中唯一官方支持的标记机制。一个数据流中只能有一个`VORBIS_COMMENT`块。在一些外部文档中，Vorbis注释被称为FLAC标记，以减少混淆。

+ `CUESHEET` 此块用于存储提示表中使用的各种信息。它支持与红皮书CD数字音频光盘兼容的音轨和索引点，以及其他CD-DA元数据，如媒体目录编号和音轨ISRC。`CUESHEET`块尤其适用于备份CD-DA光盘，但也可用作播放的通用提示机制。

+ `PICTURE` 此块用于存储与文件相关的图片，最常见的是CD的封面图。一个文件中可能有多个`PICTURE`块。图片格式类似于ID3v2中的`APIC`帧。`PICTURE`块与ID3v2一样有类型、MIME类型和UTF-8描述，并支持通过URL进行外部链接(但不鼓励这样做)。不同之处在于描述字段没有唯一性约束，而MIME类型是强制性的。FLAC图片块还包括分辨率、色深和调色板大小，这样客户端就可以搜索合适的图片，而不必全部扫描。

# 本文件中的惯例

`<>`内的为位数(比特数)，`""`内的为字符串。除非另有说明，否则所有的数字均为10进制。

后方标有`+`的部分表示其可以出现1次或多次，标有`*`的部分则可以出现0次或多次。

# FLAC流

|名称|含义|
|-|-|
|识别符|ASCII编码的`"fLaC"`|
|`METADATA_BLOCK`|元数据块|
|`METADATA_BLOCK`*|零个或多个元数据块|
|`FRAME`+|一个或多个音频帧|

## METADATA_BLOCK

|名称|含义|
|-|-|
|`METADATA_BLOCK_HEADER`|块头|
|`METADATA_BLOCK_DATA`|`METADATA_BLOCK_STREAMINFO`或`METADATA_BLOCK_PADDING`或`METADATA_BLOCK_APPLICATION`或`METADATA_BLOCK_SEEKTABLE`或`METADATA_BLOCK_VORBIS_COMMENT`或`METADATA_BLOCK_CUESHEET`或`METADATA_BLOCK_PICTURE`|

### METADATA_BLOCK_HEADER

|大小|名称|含义|
|-|-|-|
|<1>|结尾标志|若该位被设置，则当前块为最后一个块|
|<7>|块类型||
|<24>|尾随的元数据长度||

其中块类型取值如下：

+ `0` `STREAMINFO`
+ `1` `PADDING`
+ `2` `APPLICATION`
+ `3` `SEEKTABLE`
+ `4` `VORBIS_COMMENT`
+ `5` `CUESHEET`
+ `6` `PICTURE`
+ `7-126` 保留
+ `127` 无效(为避免同步错误)

### METADATA_BLOCK_STREAMINFO

|大小|名称|含义|
|-|-|-|
|<16>|最小块大小|流中最小块的采样数|
|<16>|最大块大小|流中最大块的采样数|
|<24>|最小帧大小|流中最小帧大小的字节数，`0` = 未知|
|<24>|最大帧大小|流中最大帧大小的字节数，`0` = 未知|
|<20>|采样率|单位赫兹，最大为`655350`，`0` = 未知|
|<3>|声道数|实际声道数 - 1，支持范围`1 - 8`|
|<5>|采样深度|实际采样深度 - 1，支持范围`4 - 32`|
|<36>|总采样数|单个通道采样，与通道数无关，`0` = 未知|
|<128>|MD5|未编码音频数据的MD5，用于校验音频错误|

### METADATA_BLOCK_PADDING

使用`0`字节作为填充

### METADATA_BLOCK_APPLICATION

|大小|名称|含义|
|-|-|-|
|<32>|程序ID|已注册的应用程序ID，若要注册ID或查看已有ID，需访问[ID注册页面](https://xiph.org/flac/id.html)|
|<n*8>|应用程序数据|大小为整数个字节|

### METADATA_BLOCK_SEEKTABLE

|名称|含义|
|-|-|
|`SEEKPOINT`+|一个或多个查找点。|

查找点数量可由块头长度字段 / 18算出。

`SEEKPOINT`定义如下：

|大小|名称|含义|
|-|-|-|
|<64>|目标帧采样序号|目标帧第一个样本的采样序号，`0xFFFFFFFFFFFFFFFF`表示该点为占位符。|
|<64>|目标帧偏移量|目标帧开头距第一帧开头的偏移字节数。若当前点为占位符点，则该字段的值未定义。|
|<16>|目标帧采样数|若当前点为占位符点，则该字段的值未定义。|

查找点应按采样序号升序排列。

查找点以采样序号唯一标识，不能重复，占位点除外。

因上述原因，查找表中可以含有多个占位点，所有占位点必须排在定位表最后。

### METADATA_BLOCK_VORBIS_COMMENT

也称为FLAC标记，有关详细信息，请参阅Vorbis注释(不含framing_bit)。需要注意的是，Vorbis注释规格允许2^64字节的数据，而FLAC元数据块则限制为2^24字节。考虑到Vorbis注释的既定目的，即人类可读的文本信息，实际不太可能达到这一限制。另外要注意的是，32位字段长度是根据Vorbis规范进行小端编码的，而不是FLAC其他部分通常对固定长度整数进行的大端编码。

### METADATA_BLOCK_CUESHEET

|大小|名称|含义|
|-|-|-|
|<128>*8|媒体目录编号|由ASCII可打印字符(`0x20-0x7E`)组成，不足128字节的部分用一定数量的尾随空字符补足。对于CD-DA，此字段为13个数字字符尾随115个空字符。|
|<64>|引入轨道采样数|前导样本数。该字段仅对CD-DA有意义；在其他用途中，该字段应为0。对于CD-DA，前导是存储目录的TRACK 00区域；更准确地说，它是从介质的第一个采样点到第一个音轨的第一个索引点的第一个采样点的采样数目。根据红皮书的规定，前导必须是静音的，光盘抓取软件通常不会存储前导；此外，前导必须至少有两秒钟，但也可能更长。出于这些原因，此处存储了前导音长度，以便计算第一轨道的绝对位置。请注意，此处存储的前导音是截至第一轨道第一个索引点的采样点数，而不一定是截至第一轨道INDEX 01的采样点数；即使第一轨道也可能有INDEX 00数据。|
|<1>|是否是标准 CD|若此表对应一张标准CD，此位应设为1，否则为0|
|<7+258*8>|保留区域|保留，所有位必须为0|
|<8>|音轨总数|轨道数量。必须至少为 1(因为有必要的前导音轨)。对于 CD-DA，音轨数不得超过 100(99 个普通音轨和一个前导音轨)。|
||`CUESHEET_TRACK`+|一条或多条轨道。一个CUESHEET块必须有一个前导音轨；它总是CUESHEET中的最后一个音轨。对于CD-DA，前导音轨编号必须是红皮书规定的`170`，否则必须是`255`。|

`CUESHEET_TRACK`定义如下：

|大小|名称|含义|
|-|-|-|
|<64>|音轨偏移量|样本中相对于FLAC音频流开头的轨道偏移。它是轨道第一个索引点的偏移。(注意这与CD-DA的不同，在CD-DA中，即使有索引`00`，TOC中轨道的偏移也是轨道索引`01`的偏移。)对于CD-DA，偏移必须能被588个样本整除($ 588=44100样本/秒*1/75秒 $)。|
|<8>|音轨编号|曲目编号。为避免与CD-DA规范冲突，不允许曲目编号为`0`，CD-DA规范将其保留为导入。对于CD-DA，曲目编号必须为`1-99`，或导出为`170`；对于非CD-DA，曲目编号必须为`255`，用于导出。虽然不要求，但鼓励从曲目`1`开始并依次增加。曲目编号在CUESHEET中必须是唯一的。|
|<12*8>|音轨ISRC|12字节的ASCII码数字和字母字符，若音轨没有编号，此字段填充12个空字符。有关详细信息，参阅<https://isrc.ifpi.org/en/>|
|<1>|轨道类型|`0` = 音频轨道，`1` = 非音频轨道。对应CD-DA通道控制位3|
|<1>|预加重标志|`0` = 不预加重，`1` = 预加重|
|<6+13*8>|保留区域|保留，所有位必须为0|
|<8>|索引数量|轨道索引点的数量。CUESHEET中的每个音轨必须至少有一个索引点，前导音轨除外，因为前导音轨的索引点必须为零。对于CD-DA，该数字不得超过100。|
||`CUESHEET_TRACK_INDEX`+|一个或多个索引点|

`CUESHEET_TRACK_INDEX`定义如下：

|大小|名称|含义|
|-|-|-|
|<64>|偏移|索引点相对于音轨偏移量的采样偏移量。对于CD-DA，偏移必须能被588个样本整除($ 588=44100样本/秒 * 1/75秒 $)。请注意，偏移量从音轨的起点开始，而不是音频数据的起点。|
|<8>|索引编号|索引点编号。对于CD-DA，`0`对应音轨前间隙。音轨中的第一个索引点编号必须是`0`或`1`，随后索引点编号必须以`1`为单位递增。|
|<3*8>|保留区域|保留，所有位必须为0|

### METADATA_BLOCK_PICTURE

|大小|名称|含义|
|-|-|-|
|<32>|图片类型|参阅ID3v2 APIC帧的定义。所有定义之外的数值都是保留的且不能使用。类型`1`和`2`不能同时出现。|
|<32>|MIME类型字符串长度||
|<n*8>|MIME类型|由ASCII可打印字符(`0x20-0x7E`)组成，若为`"-->"`则指示图片数据为URL。|
|<32>|描述字符串长度||
|<n*8>|UTF-8编码的描述字符串||
|<32>|图片宽度|以像素为单位|
|<32>|图片高度|以像素为单位|
|<32>|位深度||
|<32>|使用的颜色数|若图片编码为索引颜色(如GIF)，此字段指示其使用的颜色数，0表示图片不是索引颜色编码的。|
|<32>|图片数据长度||
|<n*8>|图片数据||

# 版权

**Copyright (C) 2000-2009 Josh Coalson, 2011-2022 Xiph.Org Foundation.**
